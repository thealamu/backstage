<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="1214" height="1145" contentScriptType="application/ecmascript" contentStyleType="text/css" style="width:1214px;height:1145px;background:#fefefe" preserveAspectRatio="none" version="1.1" viewBox="0 0 1214 1145" zoomAndPan="magnify"><g><text x="461.5" y="27.402" fill="#000" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="18" lengthAdjust="spacingAndGlyphs" textLength="287">OAuth Consent and Refresh Flow</text><line style="stroke:#383838;stroke-width:1;stroke-dasharray:5,5" x1="120" x2="120" y1="86.688" y2="1088.041"/><line style="stroke:#383838;stroke-width:1;stroke-dasharray:5,5" x1="419.5" x2="419.5" y1="86.688" y2="1088.041"/><line style="stroke:#383838;stroke-width:1;stroke-dasharray:5,5" x1="839" x2="839" y1="86.688" y2="1088.041"/><line style="stroke:#383838;stroke-width:1;stroke-dasharray:5,5" x1="985" x2="985" y1="86.688" y2="1088.041"/><line style="stroke:#383838;stroke-width:1;stroke-dasharray:5,5" x1="1107" x2="1107" y1="86.688" y2="1088.041"/><rect style="stroke:#383838;stroke-width:1.5" width="69" height="30.488" x="86" y="55.199" fill="#F8F8F8"/><text x="93" y="75.734" fill="#000" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="55">Browser</text><rect style="stroke:#383838;stroke-width:1.5" width="69" height="30.488" x="86" y="1087.041" fill="#F8F8F8"/><text x="93" y="1107.576" fill="#000" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="55">Browser</text><rect style="stroke:#383838;stroke-width:1.5" width="116" height="30.488" x="361.5" y="55.199" fill="#F8F8F8"/><text x="368.5" y="75.734" fill="#000" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="102">Popup Window</text><rect style="stroke:#383838;stroke-width:1.5" width="116" height="30.488" x="361.5" y="1087.041" fill="#F8F8F8"/><text x="368.5" y="1107.576" fill="#000" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="102">Popup Window</text><rect style="stroke:#383838;stroke-width:1.5" width="159" height="30.488" x="760" y="55.199" fill="#F8F8F8"/><text x="767" y="75.734" fill="#000" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="145">auth-backend plugin</text><rect style="stroke:#383838;stroke-width:1.5" width="159" height="30.488" x="760" y="1087.041" fill="#F8F8F8"/><text x="767" y="1107.576" fill="#000" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="145">auth-backend plugin</text><text x="929" y="83.734" fill="#000" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="107">Consent Screen</text><ellipse cx="985.5" cy="54.199" fill="#F8F8F8" rx="12" ry="12" style="stroke:#383838;stroke-width:2"/><polygon fill="#383838" points="981.5 42.199 987.5 37.199 985.5 42.199 987.5 47.199 981.5 42.199" style="stroke:#383838;stroke-width:1"/><text x="929" y="1100.576" fill="#000" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="107">Consent Screen</text><ellipse cx="985.5" cy="1119.529" fill="#F8F8F8" rx="12" ry="12" style="stroke:#383838;stroke-width:2"/><polygon fill="#383838" points="981.5 1107.529 987.5 1102.529 985.5 1107.529 987.5 1112.529 981.5 1107.529" style="stroke:#383838;stroke-width:1"/><text x="1052" y="83.734" fill="#000" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="105">OAuth Provider</text><ellipse cx="1107.5" cy="54.199" fill="#F8F8F8" rx="12" ry="12" style="stroke:#383838;stroke-width:2"/><line style="stroke:#383838;stroke-width:2" x1="1095.5" x2="1119.5" y1="68.199" y2="68.199"/><text x="1052" y="1100.576" fill="#000" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="105">OAuth Provider</text><ellipse cx="1107.5" cy="1119.529" fill="#F8F8F8" rx="12" ry="12" style="stroke:#383838;stroke-width:2"/><line style="stroke:#383838;stroke-width:2" x1="1095.5" x2="1119.5" y1="1133.529" y2="1133.529"/><path fill="#ECECEC" d="M8,101.6875 L8,156.6875 L233,156.6875 L233,111.6875 L223,101.6875 L8,101.6875" style="stroke:#383838;stroke-width:1"/><path fill="#ECECEC" d="M223,101.6875 L223,111.6875 L233,111.6875 L223,101.6875" style="stroke:#383838;stroke-width:1"/><text x="14" y="119.256" fill="#000" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="201">Components on page ask for an</text><text x="14" y="134.566" fill="#000" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="161">access token with greater</text><text x="14" y="149.877" fill="#000" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="204">scope than the existing session.</text><polygon fill="#383838" points="407.5 179.93 417.5 183.93 407.5 187.93 411.5 183.93" style="stroke:#383838;stroke-width:1"/><line style="stroke:#383838;stroke-width:1" x1="120.5" x2="413.5" y1="183.93" y2="183.93"/><text x="127.5" y="179.188" fill="#000" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="77">Open popup</text><polygon fill="#383838" points="827.5 209.24 837.5 213.24 827.5 217.24 831.5 213.24" style="stroke:#383838;stroke-width:1"/><line style="stroke:#383838;stroke-width:1" x1="419.5" x2="833.5" y1="213.24" y2="213.24"/><text x="426.5" y="208.498" fill="#000" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="333">GET /auth/&lt;provider&gt;/start?scope=some%20scopes</text><polygon fill="#383838" points="430.5 269.172 420.5 273.172 430.5 277.172 426.5 273.172" style="stroke:#383838;stroke-width:1"/><line style="stroke:#383838;stroke-width:1" x1="424.5" x2="838.5" y1="273.172" y2="273.172"/><text x="436.5" y="237.809" fill="#000" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="198">Redirect to consent screen with</text><text x="436.5" y="253.119" fill="#000" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="212">random nonce in OAuth state and</text><text x="436.5" y="268.43" fill="#000" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="255">short-lived cookie with the same nonce.</text><polygon fill="#383838" points="973.5 313.793 983.5 317.793 973.5 321.793 977.5 317.793" style="stroke:#383838;stroke-width:1"/><line style="stroke:#383838;stroke-width:1" x1="419.5" x2="979.5" y1="317.793" y2="317.793"/><text x="426.5" y="297.74" fill="#000" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="369">GET /consent_url?redirect_uri=&lt;redirect_uri&gt;?nonce=&lt;n&gt;</text><text x="426.5" y="313.051" fill="#000" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="422">where redirect_uri=&lt;app-origin&gt;/auth/&lt;provider&gt;/handler/frame</text><path fill="#ECECEC" d="M905,330.793 L905,370.793 L1066,370.793 L1066,340.793 L1056,330.793 L905,330.793" style="stroke:#383838;stroke-width:1"/><path fill="#ECECEC" d="M1056,330.793 L1056,340.793 L1066,340.793 L1056,330.793" style="stroke:#383838;stroke-width:1"/><text x="911" y="348.361" fill="#000" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106">User consents to</text><text x="911" y="363.672" fill="#000" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140">access the new scope.</text><polygon fill="#383838" points="430.5 393.725 420.5 397.725 430.5 401.725 426.5 397.725" style="stroke:#383838;stroke-width:1"/><line style="stroke:#383838;stroke-width:1" x1="424.5" x2="984.5" y1="397.725" y2="397.725"/><text x="436.5" y="392.982" fill="#000" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="343">Redirect to given redirect URL, with authorization code</text><polygon fill="#383838" points="827.5 438.346 837.5 442.346 827.5 446.346 831.5 442.346" style="stroke:#383838;stroke-width:1"/><line style="stroke:#383838;stroke-width:1" x1="419.5" x2="833.5" y1="442.346" y2="442.346"/><text x="426.5" y="422.293" fill="#000" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="396">GET /auth/&lt;provider&gt;/handler/frame?code=&lt;c&gt;&amp;nonce=&lt;n&gt;</text><text x="426.5" y="437.603" fill="#000" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="304">Request includes the previously set none cookie</text><path fill="#ECECEC" d="M710,455.3457 L710,495.3457 L969,495.3457 L969,465.3457 L959,455.3457 L710,455.3457" style="stroke:#383838;stroke-width:1"/><path fill="#ECECEC" d="M959,455.3457 L959,465.3457 L969,465.3457 L959,455.3457" style="stroke:#383838;stroke-width:1"/><text x="716" y="472.914" fill="#000" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="217">Verify that the nonce in the cookie</text><text x="716" y="488.225" fill="#000" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="238">matches the nonce in the OAuth state</text><polygon fill="#383838" points="1095.5 548.898 1105.5 552.898 1095.5 556.898 1099.5 552.898" style="stroke:#383838;stroke-width:1"/><line style="stroke:#383838;stroke-width:1" x1="839.5" x2="1101.5" y1="552.898" y2="552.898"/><text x="846.5" y="517.535" fill="#000" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="122">Authorization Code</text><text x="846.5" y="532.846" fill="#000" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="55">Client ID</text><text x="846.5" y="548.156" fill="#000" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79">Client Secret</text><path fill="#ECECEC" d="M1013,565.8984 L1013,590.8984 L1202,590.8984 L1202,575.8984 L1192,565.8984 L1013,565.8984" style="stroke:#383838;stroke-width:1"/><path fill="#ECECEC" d="M1192,565.8984 L1192,575.8984 L1202,575.8984 L1192,565.8984" style="stroke:#383838;stroke-width:1"/><text x="1019" y="583.467" fill="#000" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="168">Verify and generate tokens</text><polygon fill="#383838" points="850.5 674.762 840.5 678.762 850.5 682.762 846.5 678.762" style="stroke:#383838;stroke-width:1"/><line style="stroke:#383838;stroke-width:1" x1="844.5" x2="1106.5" y1="678.762" y2="678.762"/><text x="856.5" y="612.777" fill="#000" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87">Access Token</text><text x="856.5" y="628.088" fill="#000" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="65">(ID Token)</text><text x="856.5" y="643.398" fill="#000" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98">(Refresh Token)</text><text x="856.5" y="658.709" fill="#000" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="37">Scope</text><text x="856.5" y="674.019" fill="#000" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="74">Expire Time</text><polygon fill="#383838" points="430.5 719.383 420.5 723.383 430.5 727.383 426.5 723.383" style="stroke:#383838;stroke-width:1"/><line style="stroke:#383838;stroke-width:1" x1="424.5" x2="838.5" y1="723.383" y2="723.383"/><text x="436.5" y="703.33" fill="#000" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="300">Small HTML page with inlined response payload</text><text x="436.5" y="718.641" fill="#000" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="260">Store Refresh Token in HTTP-only cookie</text><polygon fill="#383838" points="131.5 748.693 121.5 752.693 131.5 756.693 127.5 752.693" style="stroke:#383838;stroke-width:1"/><line style="stroke:#383838;stroke-width:1" x1="125.5" x2="418.5" y1="752.693" y2="752.693"/><text x="137.5" y="747.951" fill="#000" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="275">postMessage() with tokens and info or error</text><line style="stroke:#383838;stroke-width:1" x1="419.5" x2="461.5" y1="782.004" y2="782.004"/><line style="stroke:#383838;stroke-width:1" x1="461.5" x2="461.5" y1="782.004" y2="795.004"/><line style="stroke:#383838;stroke-width:1" x1="420.5" x2="461.5" y1="795.004" y2="795.004"/><polygon fill="#383838" points="430.5 791.004 420.5 795.004 430.5 799.004 426.5 795.004" style="stroke:#383838;stroke-width:1"/><text x="426.5" y="777.262" fill="#000" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="62">Close self</text><path fill="#ECECEC" d="M9,808.0039 L9,863.0039 L232,863.0039 L232,818.0039 L222,808.0039 L9,808.0039" style="stroke:#383838;stroke-width:1"/><path fill="#ECECEC" d="M222,808.0039 L222,818.0039 L232,818.0039 L222,808.0039" style="stroke:#383838;stroke-width:1"/><text x="15" y="825.572" fill="#000" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174">A later point when a refresh</text><text x="19" y="840.883" fill="#000" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="176">is needed. Either because of</text><text x="19" y="856.193" fill="#000" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="198">a reload or an expiring session.</text><polygon fill="#383838" points="827.5 901.557 837.5 905.557 827.5 909.557 831.5 905.557" style="stroke:#383838;stroke-width:1"/><line style="stroke:#383838;stroke-width:1" x1="120.5" x2="833.5" y1="905.557" y2="905.557"/><text x="127.5" y="885.504" fill="#000" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="185">GET /auth/&lt;provider&gt;/token</text><text x="127.5" y="900.814" fill="#000" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194">Refresh Token cookie included</text><polygon fill="#383838" points="1095.5 961.488 1105.5 965.488 1095.5 969.488 1099.5 965.488" style="stroke:#383838;stroke-width:1"/><line style="stroke:#383838;stroke-width:1" x1="839.5" x2="1101.5" y1="965.488" y2="965.488"/><text x="846.5" y="930.125" fill="#000" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="90">Refresh Token</text><text x="846.5" y="945.436" fill="#000" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="55">Client ID</text><text x="846.5" y="960.746" fill="#000" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79">Client Secret</text><polygon fill="#383838" points="850.5 1036.73 840.5 1040.73 850.5 1044.73 846.5 1040.73" style="stroke:#383838;stroke-width:1"/><line style="stroke:#383838;stroke-width:1" x1="844.5" x2="1106.5" y1="1040.73" y2="1040.73"/><text x="856.5" y="990.057" fill="#000" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87">Access Token</text><text x="856.5" y="1005.367" fill="#000" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="65">(ID Token)</text><text x="856.5" y="1020.678" fill="#000" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="37">Scope</text><text x="856.5" y="1035.988" fill="#000" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="74">Expire Time</text><polygon fill="#383838" points="131.5 1066.041 121.5 1070.041 131.5 1074.041 127.5 1070.041" style="stroke:#383838;stroke-width:1"/><line style="stroke:#383838;stroke-width:1" x1="125.5" x2="838.5" y1="1070.041" y2="1070.041"/><text x="137.5" y="1065.299" fill="#000" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="102">Tokens and info</text></g></svg>